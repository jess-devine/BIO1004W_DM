---
title: "tidy_data_analysis.R"
author: "Jess Devine"
date: "2025-03-06"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Load packages
library(tidyverse)
library(patchwork)
library(dplyr)
library(car)
library(FSA) 
library(lubridate)
library(stringr)
library(lme4)
library(here)
library(moments)
library(fitdistrplus)
library(mgcv)

```

```{r import data}
# load tidied data 
setwd(here())
tidy_data <- readRDS(here("data", "tidy_data.rds"))
```

# Aim:
To determine if incubation period and chick mass vary with rainfall and/or mean maximum temperature, as well as group size. <br>

## Hypothese:

1) Decreased rainfall will be associated with decreased chick mass and will have no association with incubation period. <br>
2) Increased mean maximum temperature will be associated with decreased chick mass and incubation period. <br>
3) These effects will be buffered by group size. 

```{r distributions}

plot_histograms_cleaned <- function(data) {
  vars <- c("Chickmass", "incubation_period", "Rainfallspecific", "meanmaxTspecific", "Groupsize")
  
  # Define units for each variable
  units <- c("Chick Mass (g)", "Incubation Period (days)", "Rainfall (mm)", 
             "Mean Max Temperature (°C)", "Group Size (count)")
  
  plots <- list()  # Store plots
  
  for (i in seq_along(vars)) {
    var <- vars[i]
    temp_data <- data
    
    # Remove NAs only for Chickmass and Groupsize
    if (var %in% c("Chickmass", "Groupsize")) {
      temp_data <- temp_data[!is.na(temp_data[[var]]), ]
    }
    
    # Adaptive bin width calculation
    bin_width <- (max(temp_data[[var]], na.rm = TRUE) - min(temp_data[[var]], na.rm = TRUE)) / 30  
    
    # Create histogram
    p <- ggplot(temp_data, aes_string(x = var)) + 
      geom_histogram(binwidth = bin_width, fill = "grey", color = "black", alpha = 0.7) +
      labs(x = units[i], y = "Frequency") +  # Use labeled units
      theme_minimal()
    
    plots[[i]] <- p  # Store the plot
  }
  
  # Arrange all histograms in a panel (2 rows, 3 columns)
  final_plot <- (plots[[1]] + plots[[2]]) / (plots[[3]] + plots[[4]] + plots[[5]]) +
    plot_layout(guides = "collect")
  
  print(final_plot)  # Display the panel
}

# Call the function on your dataset
plot_histograms_cleaned(tidy_data)


```
<br> **Figure 1:** The distributions of variables of interest. 

Group size looks somewhat noramlly ditributed but the other variables are not noramlly distributed.

```{r outliers}

```

```{r tidy_data_exploration}

# Function to create scatterplots with r-value annotation
create_scatter <- function(data, x_var, y_var, x_label, y_label) {
  cor_value <- cor(data[[x_var]], data[[y_var]], use = "complete.obs")  # Compute correlation
  
  ggplot(data, aes(x = .data[[x_var]], y = .data[[y_var]])) +
    geom_point(color = "black", alpha = 0.7, size = 0.5) +  
    theme_minimal() +
    labs(x = x_label, y = y_label) +
    annotate("text", 
             x = max(data[[x_var]], na.rm = TRUE),  
             y = max(data[[y_var]], na.rm = TRUE),  
             label = paste0("r = ", round(cor_value, 2)),  
             hjust = 1.1, vjust = 1.1,  
             size = 3, color = "darkred") + # Adjust text size & color
    theme(
      axis.text = element_text(size = 7)     # Adjusts tick label size
    )
}


# Function to create boxplots
create_boxplot <- function(data, x_var, y_var, x_label, y_label) {
  ggplot(data, aes(x = as.factor(.data[[x_var]]), y = .data[[y_var]])) +
    geom_boxplot() +
    theme_minimal() +
    labs(x = x_label, y = y_label)
}

# Remove NAs only from relevant variables
tidy_data_filtered <- tidy_data %>%
  drop_na(Rainfallspecific, meanmaxTspecific, incubation_period, Chickmass, Groupsize)

# Incubation Period Plots
p1 <- create_scatter(tidy_data_filtered, "Rainfallspecific", "incubation_period", "Rainfall (mm)", "Incubation Period (days)")
p2 <- create_scatter(tidy_data_filtered, "meanmaxTspecific", "incubation_period", "Mean Max Temperature (°C)", "")
p3 <- create_boxplot(tidy_data_filtered, "Groupsize", "incubation_period", "Group Size", "")

# Chick Mass Plots
p4 <- create_scatter(tidy_data_filtered, "Rainfallspecific", "Chickmass", "Rainfall (mm)", "Chick Mass (g)")
p5 <- create_scatter(tidy_data_filtered, "meanmaxTspecific", "Chickmass", "Mean Max Temperature (°C)", "")
p6 <- create_boxplot(tidy_data_filtered, "Groupsize", "Chickmass", "Group Size", "")

# Arrange plots in a 2x3 panel
(p4 + p5 + p6) / (p1 + p2 + p3)
```

**Figure 2:** The incubation period of eggs (top panel) and mass of chicks (bottom panel) plotted against rainfall in mm (left panel), mean maximum temperature °C (middle panel) and group size (right panel). 

The relationship between chick mass and group size looks promising. There don't seem to be any linear relationships. 

Let's try 

########################

```{r normailty}
# QQ plots
ggplot(tidy_data, aes(sample = Chickmass)) + 
  stat_qq() + stat_qq_line() +
  theme_minimal()

ggplot(tidy_data, aes(sample = incubation_period)) + 
  stat_qq() + stat_qq_line() +
  theme_minimal()

# Shapiro-Wilk test for normality
shapiro.test(tidy_data$Chickmass) 
shapiro.test(tidy_data$incubation_period)  

tidy_data_filtered <- tidy_data %>% filter(!is.na(Chickmass))
descdist(tidy_data_filtered$Chickmass, discrete = FALSE)
descdist(tidy_data$incubation_period, discrete = FALSE)
```

Both variables (incubation period and chick mass) do not follow a normal distribution based on the Shapiro-Wilk test. However, chick mass is closer to normal than incubation period. Chick mass could use a log transformation and incubation period a Weibull (due to high kurtosis ie heavy tails).  

```{r kruskal-wallis}
# Kruskal-Wallis Test 
kruskal.test(incubation_period ~ as.factor(Groupsize), data = tidy_data)
kruskal.test(Chickmass ~ as.factor(Groupsize), data = tidy_data)
kruskal.test(incubation_period ~ Rainfallspecific, data = tidy_data)
kruskal.test(Chickmass ~ Rainfallspecific, data = tidy_data)
kruskal.test(incubation_period ~ meanmaxTspecific, data = tidy_data)
kruskal.test(Chickmass ~ meanmaxTspecific, data = tidy_data)
```
There are significant differences in both incubation period () and chick mass () across different group size categories.

```{r dunn}
# Dunn’s test for pairwise comparisons
dunnTest(Chickmass ~ as.factor(Groupsize), data = tidy_data, method = "bonferroni")
dunnTest(incubation_period ~ as.factor(Groupsize), data = tidy_data, method = "bonferroni")
``` 
The chick mass of clutches of groups of size seven differs significantly from the chick mass of groups of size two (p adjusted = 0.0004), three (p adjusted = 0.0009) and four (p adjusted = 0.0009); and marginally from groups of size five (p adjusted = 0.0080). Groups of size 6 did not have significantly differnt chick mass. Therefore, the largest group size was associated with higher chick mass than nearly all other groups sizes. This suggests that being in a larger group is beneficial.  
<br>
The incubation period of clutches of groups of size six differs significantly from the incubation period of groups of size two(p adjusted = 0.001), three (p adjusted = 0.001) and seven (p adjusted = 0.010); and marginally from groups of size four (p adjusted = 0.067). Therefore, the incubation period of clutches of group size 6 was significantly lower than other group sizes. 


```{r GAM_chickmass}
m1 = gam(log(Chickmass) ~ s(Rainfallspecific), data = tidy_data)
m2 = gam(log(Chickmass) ~ s(meanmaxTspecific), data = tidy_data)
m3 = gam(log(Chickmass) ~ te(Groupsize), data = tidy_data)

m4 = gam(log(Chickmass) ~ s(Rainfallspecific) + te(Groupsize), data = tidy_data)
m5 = gam(log(Chickmass) ~ s(meanmaxTspecific) + te(Groupsize), data = tidy_data)
m6 = gam(log(Chickmass) ~ s(meanmaxTspecific) + s(Rainfallspecific), data = tidy_data)

m7 = gam(log(Chickmass) ~ s(meanmaxTspecific) + s(Rainfallspecific) + te(Groupsize), data = tidy_data)
m8 = gam(log(Chickmass) ~ s(meanmaxTspecific) + te(Rainfallspecific, Groupsize), data = tidy_data)
m9 = gam(log(Chickmass) ~ te(meanmaxTspecific, Groupsize) + s(Rainfallspecific), data = tidy_data)
m10 = gam(log(Chickmass) ~ te(meanmaxTspecific, Rainfallspecific) + te(Groupsize), data = tidy_data)
m11 = gam(log(Chickmass) ~ te(Rainfallspecific, meanmaxTspecific, Groupsize), data = tidy_data) 


# Store models in a list
models <- list(m1, m2, m3, m4, m5, m6, m7, m8, m9, m10, m11, m12, m13, m14)

# Loop through models and extract AIC
aic_values <- sapply(models, function(m) AIC(m))

# Print AIC values for each model
aic_results <- data.frame(Model = paste0("m", 1:14), AIC = aic_values)

# Find the best model (lowest AIC)
best_model <- aic_results[which.min(aic_results$AIC), ]
cat("Chick mass: best model based on AIC:", best_model$Model, "with AIC =", best_model$AIC, "\n")

```

```{r assumptions}
plot(m14)
gam.check(m14)
hist(residuals(m14))
qqnorm(residuals(m14))

```