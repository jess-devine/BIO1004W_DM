---
title: "Data Management and Reproducible Research Deliverable: <br> Data Tidying"
author: "Jess Devine"
date: "2025-02-20"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Install tidyverse if not installed
if (!requireNamespace("tidyverse", quietly = TRUE)) install.packages("tidyverse")
if (!requireNamespace("here", quietly = TRUE)) install.packages("here")

# Load packages
library(tidyverse)
library(here)
```

### Import data

```{r import data}
# import data 
data <- read_csv2(here("data", "Chick_condition.csv"))

# checking data
summary(data)
length(data)
head(data[,1:8])
tail(data[,1:8])
head(data[,9:17])
tail(data[,9:17]) # NOTE: `Fledge date` changes format 
n_a_counts <- sapply(data, function(x) if (is.character(x)) sum(x == "n/a", na.rm = TRUE) else 0); n_a_counts
```

### Data tyding 

```{r data tidying}

# Replace "n/a" and empty strings with proper NA
tidy_data  <- data %>%
  mutate(across(where(is.character), ~ na_if(.x, "n/a"))) %>%
  mutate(across(where(is.character), ~ na_if(.x, ""))) 
n_a_counts <- sapply(data, function(x) if (is.character(x)) sum(x == "n/a", na.rm = TRUE) else 0); n_a_counts

tidy_data <- tidy_data  %>%
  mutate(
    # Convert to Date safely, replacing invalid values with NA
    `Lay date` = suppressWarnings(as.Date(`Lay date`, format = "%Y-%m-%d")),
    `Hatch date` = suppressWarnings(as.Date(`Hatch date`, format = "%Y-%m-%d")),
    Ringingdate = suppressWarnings(as.Date(Ringingdate, format = "%d/%m/%Y")),
    
    # Handle mixed Fledge date formats and invalid cases
    `Fledge date` = case_when(
      str_detect(`Fledge date`, "^\\d{4}/") ~ suppressWarnings(ymd(str_replace(`Fledge date`, "/", "-"))),
      str_detect(`Fledge date`, "^\\d{2}/\\d{2}/\\d{4}$") ~ suppressWarnings(dmy(`Fledge date`)),
      TRUE ~ NA_Date_
    ),
    
    # Convert to numeric safely, replacing non-numeric values with NA
    Groupsize = suppressWarnings(as.numeric(Groupsize)),
    Chickmass = suppressWarnings(as.numeric(Chickmass)),
    Tarsuslength = suppressWarnings(as.numeric(Tarsuslength)),

    # Convert to factor
    Year = as.factor(Year),
    Group = as.factor(Group),
    Nest = as.factor(Nest)
  )

# Identify problematic rows where NA was introduced
problematic_rows <- data %>%
  filter(
    is.na(tidy_data$`Fledge date`) & !is.na(`Fledge date`) |
    is.na(tidy_data$Tarsuslength) & !is.na(Tarsuslength)
  )
length(problematic_rows)
print(problematic_rows[,1:8])
print(problematic_rows[,9:17])

# demographic groups to long format and compute incubation period
tidy_data <- tidy_data %>%
  pivot_longer(
    cols = c(Afem, Amal, SA, Juv), 
    names_to = "Age_Sex_Class", 
    values_to = "Count") %>%
      mutate(
        Count = as.integer(Count), # Convert to integer
        Age_Sex_Class = as.factor(Age_Sex_Class), # convert to factor
        incubation_period = as.numeric(`Hatch date` - `Lay date`)  # Compute incubation period 
         ) 

head(tidy_data)
colSums(is.na(tidy_data))
```

